# dns-txt-proxy 详细部署指南

基于 DNS TXT 记录的轻量级代理工具，通过 DNS 协议传输数据，适用于受限网络环境。本指南将详细介绍在不同操作系统中的完整部署流程。

## 目录



*   [项目概述](#项目概述)

*   [环境准备](#环境准备)

*   [Windows 系统部署](#windows-系统部署)


    *   [基础运行（Python 环境）](#基础运行python-环境)

    *   [打](#打包为-exe-可执行文件)[包为](#打包为-exe-可执行文件)[ E](#打包为-exe-可执行文件)[X](#打包为-exe-可执行文件)[E](#打包为-exe-可执行文件)[ 可执](#打包为-exe-可执行文件)[行](#打包为-exe-可执行文件)[文](#打包为-exe-可执行文件)[件](#打包为-exe-可执行文件)

    *   [注](#注册为系统服务开机自启)[册为](#注册为系统服务开机自启)[系统](#注册为系统服务开机自启)[服务](#注册为系统服务开机自启)[（开](#注册为系统服务开机自启)[机自](#注册为系统服务开机自启)[启）](#注册为系统服务开机自启)

*   [Lin](#linux-系统部署)[ux](#linux-系统部署)[ 系统部](#linux-系统部署)[署](#linux-系统部署)


    *   [基础](#基础运行以-ubuntu-为例)[运行（](#基础运行以-ubuntu-为例)[以 Ub](#基础运行以-ubuntu-为例)[unt](#基础运行以-ubuntu-为例)[u 为](#基础运行以-ubuntu-为例)[例）](#基础运行以-ubuntu-为例)

    *   [配置](#配置-systemd-服务开机自启)[ sy](#配置-systemd-服务开机自启)[stem](#配置-systemd-服务开机自启)[d](#配置-systemd-服务开机自启)[ 服务（开](#配置-systemd-服务开机自启)[机自启](#配置-systemd-服务开机自启)[）](#配置-systemd-服务开机自启)

*   [Op](#openwrt-系统部署)[enW](#openwrt-系统部署)[RT](#openwrt-系统部署)[ 系统](#openwrt-系统部署)[部署](#openwrt-系统部署)


    *   [基础运](#基础运行)[行](#基础运行)

    *   [配](#配置自启动服务)[置自启](#配置自启动服务)[动服](#配置自启动服务)[务](#配置自启动服务)

*   [多实](#多实例配置通过配置文件)[例配置](#多实例配置通过配置文件)[（通](#多实例配置通过配置文件)[过配置](#多实例配置通过配置文件)[文件）](#多实例配置通过配置文件)

*   [服务](#服务管理与日志查看)[管理与](#服务管理与日志查看)[日志查](#服务管理与日志查看)[看](#服务管理与日志查看)

*   [常](#常见问题排查)[见问题排查](#常见问题排查)

*   [许](#许可证)[可证](#许可证)

## 项目概述

`dns-txt-proxy` 利用 DNS 协议的 TXT 记录字段进行数据传输，可在常规网络协议被限制时建立代理连接。工具通过定期查询目标域名的 TXT 记录获取转发指令，将本地端口的流量通过 DNS 通道转发。

## 环境准备



*   **操作系统支持**：


    *   Windows 7 及以上版本

    *   Linux（Ubuntu 16.04+、Debian 9+、CentOS 7+ 等）

    *   OpenWRT 18.06 及以上版本

*   **依赖环境**：


    *   Python 3.6 及以上版本

    *   Git（用于克隆仓库）

*   **网络要求**：


    *   允许 DNS 解析（UDP 53 端口出站）

    *   目标 DNS 服务器可访问

## Windows 系统部署

### 基础运行（Python 环境）

#### 步骤 1：安装 Python



1.  访问 [Pyt](https://www.python.org/downloads/)[hon](https://www.python.org/downloads/)[ 官网](https://www.python.org/downloads/) 下载 Windows 版本安装包（推荐 3.8+）

2.  运行安装包，**务必勾选 “Add Python to PATH”**，然后点击 “Install Now”

3.  验证安装：打开命令提示符（Win+R 输入 `cmd`），执行 `python --version`，显示版本号即安装成功

#### 步骤 2：克隆仓库并安装依赖



1.  打开命令提示符，执行以下命令：



```
\# 安装 Git（若未安装）

\# 访问 https://git-scm.com/download/win 下载安装，勾选"Add Git to PATH"

\# 克隆项目仓库

git clone https://github.com/nary24/dns-txt-proxy.git

cd dns-txt-proxy

\# 安装依赖包

pip install -r requirements.txt
```

#### 步骤 3：启动程序



```
\# 基本启动命令（替换为实际参数）

python dns-txt-proxy.py --domain your-proxy-domain.com --local-port 8080 --protocol tcp --dns-servers 8.8.8.8 1.1.1.1
```

看到类似 “Proxy started on port 8080” 的输出即启动成功

### 打包为 EXE 可执行文件

若需在无 Python 环境的机器上运行，可打包为 EXE：



1.  安装打包工具：



```
pip install pyinstaller
```



1.  执行打包命令：



```
pyinstaller --onefile --name dns-txt-proxy dns-txt-proxy.py
```



1.  获取 EXE 文件：

    打包完成后，在项目目录下生成 `dist` 文件夹，其中的 `dns-txt-proxy.exe` 即为可执行文件

2.  验证 EXE：



```
dist\dns-txt-proxy.exe --help
```

显示帮助信息即打包成功

### 注册为系统服务（开机自启）

使用 NSSM 工具将 EXE 注册为系统服务，实现后台运行和开机自启：

#### 步骤 1：下载并安装 NSSM



1.  访问 [N](https://nssm.cc/download)[SSM](https://nssm.cc/download)[ 官网](https://nssm.cc/download)，下载对应系统版本（32 位 / 64 位）

2.  解压压缩包，将 `nssm.exe` 复制到 `C:\Windows\System32` 目录（无需安装，直接复制即可）

#### 步骤 2：注册服务



1.  以管理员身份打开命令提示符（右键 “命令提示符”→“以管理员身份运行”）

2.  执行以下命令启动 NSSM 配置界面：



```
nssm install dns-txt-proxy
```

#### 步骤 3：配置服务参数

在弹出的窗口中按以下要求配置：



*   **Application 选项卡**：


    *   Path：点击 “...” 按钮，选择之前生成的 `dns-txt-proxy.exe` 路径（例如 `C:\dns-txt-proxy\dist\dns-txt-proxy.exe`）

    *   Arguments：输入启动参数（例如 `--domain ``your-proxy-domain.com`` --local-port 8080`）

    *   Startup directory：选择 EXE 所在文件夹（例如 `C:\dns-txt-proxy\dist`）

*   **Details 选项卡**：


    *   Display name：可自定义服务名称（如 “DNS TXT Proxy”）

    *   Description：可添加描述信息（如 “基于 DNS TXT 记录的代理服务”）

*   **Log on 选项卡**：保持默认的 “Local System account” 即可

*   **Startup 选项卡**：选择 “Automatic”（自动启动）

配置完成后点击 “Install service”，弹出 “Service installed successfully” 提示即注册成功

## Linux 系统部署

### 基础运行（以 Ubuntu 为例）

#### 步骤 1：安装依赖



```
\# 更新软件源

sudo apt update

\# 安装 Python 及相关工具

sudo apt install -y python3 python3-pip python3-dev git
```

#### 步骤 2：克隆仓库并安装依赖



```
\# 克隆项目仓库

git clone https://github.com/nary24/dns-txt-proxy.git

cd dns-txt-proxy

\# 安装依赖包

pip3 install -r requirements.txt
```

#### 步骤 3：启动程序



```
\# 基本启动命令（替换为实际参数）

python3 dns-txt-proxy.py --domain your-proxy-domain.com --local-port 8080 --protocol udp --interval 5
```

看到类似 “Proxy started on port 8080” 的输出即启动成功

### 配置 systemd 服务（开机自启）

#### 步骤 1：创建服务文件



```
sudo nano /etc/systemd/system/dns-txt-proxy.service
```

#### 步骤 2：编写服务配置

粘贴以下内容（注意替换路径和参数）：



```
\[Unit]

Description=DNS TXT Proxy Service

After=network.target

Wants=network-online.target

\[Service]

Type=simple

\# 运行用户（建议使用非root用户，需提前创建）

User=proxyuser

Group=proxyuser

\# 项目目录

WorkingDirectory=/home/proxyuser/dns-txt-proxy

\# 启动命令（替换为实际参数）

ExecStart=/usr/bin/python3 /home/proxyuser/dns-txt-proxy/dns-txt-proxy.py --domain your-proxy-domain.com --local-port 8080

\# 异常退出时自动重启

Restart=always

RestartSec=3

\# 启动超时设置

TimeoutStartSec=30

\# 日志输出

StandardOutput=journal

StandardError=journal

\[Install]

WantedBy=multi-user.target
```

按 `Ctrl+O` 保存，`Ctrl+X` 退出编辑器

#### 步骤 3：创建运行用户（可选）



```
\# 创建用户（若使用非root用户）

sudo useradd -m proxyuser

\# 赋予项目目录权限

sudo chown -R proxyuser:proxyuser /home/proxyuser/dns-txt-proxy
```

#### 步骤 4：启用并启动服务



```
\# 重新加载systemd配置

sudo systemctl daemon-reload

\# 启动服务

sudo systemctl start dns-txt-proxy

\# 设置开机自启

sudo systemctl enable dns-txt-proxy
```

## OpenWRT 系统部署

### 基础运行

#### 步骤 1：安装依赖



```
\# 更新软件源

opkg update

\# 安装必要组件

opkg install python3 python3-pip git
```

#### 步骤 2：克隆仓库并安装依赖



```
\# 克隆项目（建议放在 /opt 目录）

mkdir -p /opt

cd /opt

git clone https://github.com/nary24/dns-txt-proxy.git

cd dns-txt-proxy

\# 安装依赖（OpenWRT 可能需要指定镜像源）

pip3 install -r requirements.txt --index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

#### 步骤 3：启动程序



```
\# 基本启动命令

python3 dns-txt-proxy.py --domain your-proxy-domain.com --local-port 8080 --protocol tcp
```

### 配置自启动服务

#### 步骤 1：创建启动脚本



```
nano /etc/init.d/dns-txt-proxy
```

#### 步骤 2：编写启动脚本

粘贴以下内容：



```
\#!/bin/sh /etc/rc.common

START=95

STOP=10

start() {

&#x20;   echo "Starting dns-txt-proxy..."

&#x20;   \# 替换为实际路径和参数

&#x20;   /usr/bin/python3 /opt/dns-txt-proxy/dns-txt-proxy.py --domain your-proxy-domain.com --local-port 8080 > /var/log/dns-txt-proxy.log 2>&1 &

}

stop() {

&#x20;   echo "Stopping dns-txt-proxy..."

&#x20;   killall -f dns-txt-proxy.py

}

restart() {

&#x20;   stop

&#x20;   start

}
```

保存并退出

#### 步骤 3：设置权限并启用自启



```
\# 赋予执行权限

chmod +x /etc/init.d/dns-txt-proxy

\# 启用自启动

/etc/init.d/dns-txt-proxy enable

\# 启动服务

/etc/init.d/dns-txt-proxy start
```

## 多实例配置（通过配置文件）

若需运行多个代理实例，可通过配置文件管理：



1.  创建配置文件 `config.conf`：



```
\[proxy1]

domain = proxy1.example.com

local\_port = 9001

protocol = tcp

interval = 5

stability = 2

dns\_servers = 8.8.8.8 8.8.4.4

log\_file = proxy1.log

\[proxy2]

domain = proxy2.example.com

local\_port = 9002

protocol = udp

interval = 3

stability = 1

dns\_servers = 1.1.1.1 1.0.0.1

debug = true
```



1.  通过配置文件启动：



```
\# Windows

python dns-txt-proxy.py --config config.conf

\# 或 EXE 方式

dist\dns-txt-proxy.exe --config config.conf

\# Linux/OpenWRT

python3 dns-txt-proxy.py --config config.conf
```

## 服务管理与日志查看

### Windows 服务管理



```
\# 启动服务

nssm start dns-txt-proxy

\# 停止服务

nssm stop dns-txt-proxy

\# 重启服务

nssm restart dns-txt-proxy

\# 查看服务状态

nssm status dns-txt-proxy

\# 卸载服务

nssm remove dns-txt-proxy confirm
```

### Linux 服务管理



```
\# 查看服务状态

sudo systemctl status dns-txt-proxy

\# 启动服务

sudo systemctl start dns-txt-proxy

\# 停止服务

sudo systemctl stop dns-txt-proxy

\# 重启服务

sudo systemctl restart dns-txt-proxy

\# 查看日志（实时）

sudo journalctl -u dns-txt-proxy -f

\# 查看所有日志

sudo journalctl -u dns-txt-proxy --no-pager
```

### OpenWRT 服务管理



```
\# 查看状态

/etc/init.d/dns-txt-proxy status

\# 启动

/etc/init.d/dns-txt-proxy start

\# 停止

/etc/init.d/dns-txt-proxy stop

\# 重启

/etc/init.d/dns-txt-proxy restart

\# 查看日志

tail -f /var/log/dns-txt-proxy.log
```

## 常见问题排查



1.  **Python 版本不兼容**

*   症状：启动时报语法错误或模块错误

*   解决：确认 Python 版本 ≥3.6，执行 `python --version` 或 `python3 --version` 检查

1.  **端口被占用**

*   症状：启动时报 “Address already in use” 或 “端口已被占用”

*   解决：



```
\# Windows 查看占用端口的进程

netstat -ano | findstr "8080"

\# 根据 PID 结束进程

taskkill /PID 进程ID /F

\# Linux/OpenWRT 查看占用端口的进程

netstat -tuln | grep 8080

\# 或

lsof -i :8080

\# 结束进程

kill -9 进程ID
```



*   替代方案：更换 `--local-port` 参数使用其他端口

1.  **DNS 解析失败**

*   症状：日志中频繁出现 “DNS query failed”

*   解决：


    *   更换 DNS 服务器：`--dns-servers ``8.8.8.8`` ``1.1.1.1`

    *   检查网络连接和防火墙设置，确保允许 UDP 53 端口出站

    *   确认目标域名的 TXT 记录已正确配置

1.  **服务启动失败（Linux）**

*   症状：`systemctl status` 显示 “failed”

*   解决：


    *   检查服务文件路径是否正确（`WorkingDirectory` 和 `ExecStart`）

    *   确认 Python 路径正确：`which python3`

    *   查看详细日志：`sudo journalctl -u dns-txt-proxy --no-pager`

    *   检查文件权限：确保运行用户有项目目录的访问权限

1.  **服务启动失败（Windows）**

*   症状：服务启动后立即停止或状态异常

*   解决：


    *   检查 NSSM 配置的路径是否包含中文或空格

    *   尝试手动运行 EXE 确认是否能正常启动

    *   在 NSSM 的 “Output” 选项卡中设置日志文件，查看具体错误

## 许可证

本项目采用 [MIT 许可证](LICENSE) 开源，允许自由使用、修改和分发。



***

若有其他问题，欢迎提交 [Issue](https://github.com/nary24/dns-txt-proxy/issues) 获取帮助。

> （注：文档部分内容可能由 AI 生成）